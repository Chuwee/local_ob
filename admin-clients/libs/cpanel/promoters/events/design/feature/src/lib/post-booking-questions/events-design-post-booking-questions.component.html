<app-form-container (cancel)="refresh()" (save)="save()" [formGroup]="form" [disabled]="!form.dirty || $isLoadingOrSaving()" layout="menu">
    <div class="post-booking-status-container" slot="outside">
        <mat-slide-toggle class="ob-slide-toggle" [formControl]="formControls.enablePbQuestions">
            {{ 'EVENTS.QUESTIONS.FORMS.LABELS.ENABLE_POST_BOOKING_QUESTIONS' | translate }}
        </mat-slide-toggle>
    </div>
    <mat-accordion [multi]="true" [togglePosition]="'before'">

        <!-- Post booking quesitons -->
        <mat-expansion-panel [expanded]="true">
            <mat-expansion-panel-header expandedHeight="*" collapsedHeight="*">
                <mat-panel-title>
                    {{ 'EVENTS.QUESTIONS.TITLES.QUESTIONS' | translate }}
                </mat-panel-title>
            </mat-expansion-panel-header>

            <p>{{ 'EVENTS.QUESTIONS.FORMS.INFOS.QUESTIONS' | translate }}</p>

            @if ($hasSelectedQuestions()) {
                <div class="flex flex-col gap-4">
                    <div class="flex justify-end">
                        <button mat-stroked-button class="ob-button" color="primary" (click)="openPbQuestionsDialog()">
                            <mat-icon>edit</mat-icon>
                            {{ 'EVENTS.QUESTIONS.ACTIONS.EDIT_POST_BOOKING_QUESTIONS' | translate }}
                        </button>
                    </div>
                    <mat-list class="ob-list">
                        <h3 class="list-header"> {{ 'EVENTS.QUESTIONS.TITLES.QUESTIONS' | translate }} </h3>
                        @for (question of $selectedQuestions(); track question.id) {
                            <mat-list-item role="listitem" class="hoverable-item">
                                <span>{{ question.name }}</span>
                            </mat-list-item>
                        }
                    </mat-list>
                </div>
            } @else {
                <app-empty-state-tiny
                    [title]="'EVENTS.QUESTIONS.FORMS.INFOS.EMPTY_QUESTIONS' | translate"
                    [description]="'EVENTS.QUESTIONS.FORMS.INFOS.EMPTY_QUESTIONS_DESC' | translate">
                    <button mat-stroked-button class="ob-button" color="primary" (click)="openPbQuestionsDialog()">
                        <mat-icon>add</mat-icon>
                        {{'EVENTS.QUESTIONS.ACTIONS.ADD_POST_BOOKING_QUESTION' | translate}}
                    </button>
                </app-empty-state-tiny>
            }
        </mat-expansion-panel>

        <!-- Channels -->
        <mat-expansion-panel [expanded]="true">
            <mat-expansion-panel-header expandedHeight="*" collapsedHeight="*">
                <mat-panel-title>
                    {{ 'EVENTS.QUESTIONS.TITLES.SALE_CHANNEL' | translate }}
                </mat-panel-title>
            </mat-expansion-panel-header>

            <p>{{ 'EVENTS.QUESTIONS.FORMS.INFOS.SALE_CHANNEL' | translate }}</p>

            <div class="channels-scope flex flex-wrap" [formGroup]="form">
                <mat-radio-group class="flex flex-col basis-full" [formControl]="formControls.channelsSelectionType">

                    <mat-radio-button class="ob-radio-button vertical-list" [value]="channelsScopeType.all">
                        {{ 'FORMS.LABELS.ALL_CHANNELS' | translate }}
                    </mat-radio-button>

                    <mat-radio-button class="ob-radio-button vertical-list" [value]="channelsScopeType.list">
                        {{ 'FORMS.LABELS.SELECTED_CHANNELS' | translate }}
                    </mat-radio-button>
                </mat-radio-group>

                @if (formControls.channelsSelectionType.value === channelsScopeType.list) {
                    <div class="channel-selection-container nested-content flex flex-col">

                        <div class="post-booking-channels">
                            @let channelsControl = formControls.channels;
                            <div [class.field-error]="channelsControl.invalid && channelsControl.touched">
                                <app-searchable-paginated-selection class="ob-medium-list"
                                    [placeholder]="'FORMS.SEARCH_CHANNEL_FIELD' | translate" [form]="channelsControl"
                                    [pageSize]="pageSize" [data$]="channels$" [metadata$]="channelsMetadata$"
                                    [loading$]="channelsLoading$" (loadData)="channelsFilterChangeHandler($event)">

                                    <ng-template #selectionTemplate
                                        let-pageForm="pageForm" let-data="data" let-selectionChanged="selectionChanged">
                                        <app-selection-list class="small-rows" [data]="data"
                                            [pageForm]="pageForm" [selectionChanged]="selectionChanged">
                                            <ng-template #optionTemplate let-row>
                                                <span>{{row.name}}</span>
                        </ng-template>
                        </app-selection-list>
                        </ng-template>
                        </app-searchable-paginated-selection>
                        </div>
                        @if (channelsControl.hasError('required') && channelsControl.touched) {
                            <span class="error-description">
                                {{'FORMS.ERRORS.REQUIRED_FIELD' | translate}}
                            </span>
                        }
                    </div>

            </div>
            }

            </div>
        </mat-expansion-panel>
    </mat-accordion>
</app-form-container>

@if ($isLoadingOrSaving()) {
    <div class="spinner-container">
        <mat-spinner />
    </div>
}