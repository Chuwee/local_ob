<div class="list-container" fxFlex="100%" fxLayout="column">
    <div class="heading-container" fxLayout="row wrap" fxLayoutAlign="space-between start">
        <div>
            <h1 class="secondary mat-headline-3">{{'TITLES.PAYOUTS' | translate}}</h1>
        </div>
        <div class="actions-container" fxFlex="auto" fxLayout="row wrap" fxLayoutAlign="end">
            <div class="filter-container" fxFlex="none">
                <button mat-icon-button class="ob-button medium" aria-label="refresh" (click)="refresh()">
                    <mat-icon>autorenew</mat-icon>
                </button>
            </div>
            @if(isExportEnabled$ | async){
                <div class="filter-container" fxFlex="none">
                    <button mat-stroked-button color="tertiary" class="ob-button medium only-icon"
                        [matMenuTriggerFor]="ordersListMenu">
                        <mat-icon>more_horiz</mat-icon>
                    </button>
                    <mat-menu #ordersListMenu="matMenu">
                        <button mat-menu-item [disabled]="(payoutsMetadata$ | async)?.total === 0" (click)="exportPayouts()">
                            {{'ACTIONS.EXPORT.BTN' | translate}}
                        </button>
                    </mat-menu>
                </div>
            }
        </div>
    </div>
    <div class="heading-container" fxLayout="row" fxLayoutAlign="space-between center">
        <div fxFlex="80%" fxLayoutGap="20px" fxLayoutAlign="start center">
            <div class="filter-container" fxFlex="none">
                <app-popover-date-range-picker-filter />
            </div>
            <div class="filter-container" fxFlex="none">
                <app-popover appFilter>
                    <app-payouts-list-filter [startDate]="startDate" [endDate]="endDate" #filterContent />
                </app-popover>
            </div>
            <div class="search-field" fxFlex="100%">
                <app-search-input [placeholder]="'PAYOUT.SEARCH_INPUT' | translate" (valueChanged)="applyRelevance($event)" />
            </div>
        </div>
        <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px">
            @if(payoutsMetadata$ | async; as payoutsMetadata){
                <p class="page-summary"
                    [innerHTML]="'PAGINATION.PAGE_SUMMARY' | translate: payoutsMetadata">
                </p>
            }
            <app-paginator [length]="(payoutsMetadata$ | async)?.total" [pageSize]="pageSize" />
        </div>
    </div>
    <div class="heading-container heading-divider">
        <mat-divider />
    </div>
    <div class="heading-container">
        <app-chips appFilter />
    </div>
    @if(reqInProgress$ | async){
        <div class="spinner-container">
            <mat-spinner />
        </div>
    }

    <mat-table cdkDropList (cdkDropListDropped)="dropItem($event)"
        cdkDropListOrientation="horizontal" class="ob-table ob-table-drop-list payouts-table" [dataSource]="payouts$ | async"
        [attr.aria-label]="'TITLES.PAYOUTS' | translate"
        [hidden]="!((payoutsMetadata$ | async)?.total > 0)">
        <ng-container [matColumnDef]="payoutsColumns.code">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(payoutsColumns.code)"
                cdkDragLockAxis="x" *matHeaderCellDef class="head-cell ob-draggable-column width200">
                {{'FORMS.LABELS.CODE' | translate}}
            </mat-header-cell>
            <mat-cell *matCellDef="let row" class="width200">
                <div fxFlex="0 0 100%" fxLayoutAlign="start center">
                    <a class="ob-link" [routerLink]="['/transactions', row.original_order_code, 'tickets', row.location?.id]"><span
                            fxFlex="0 1 100%" appEllipsify
                            [matTooltip]="row.original_order_code">{{row.original_order_code}}</span></a>
                    <app-copy-text [copyText]="row.original_order_code" class="copy-button" />
                </div>
            </mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="payoutsColumns.channel">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(payoutsColumns.channel)" cdkDragLockAxis="x"
                *matHeaderCellDef class="head-cell ob-draggable-column width200">
                {{'FORMS.LABELS.CHANNEL' | translate}}
            </mat-header-cell>
            <mat-cell class="width200" *matCellDef="let row">{{row.location?.channel?.name}}</mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="payoutsColumns.event">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(payoutsColumns.event)" cdkDragLockAxis="x"
                *matHeaderCellDef class="head-cell ob-draggable-column width200">
                {{'FORMS.LABELS.EVENT' | translate}}
            </mat-header-cell>
            <mat-cell class="width200" *matCellDef="let row">{{row.location?.event?.name}}</mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="payoutsColumns.session">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(payoutsColumns.session)" cdkDragLockAxis="x"
                *matHeaderCellDef class="head-cell ob-draggable-column width200">
                {{'FORMS.LABELS.SESSION' | translate}}
            </mat-header-cell>
            <mat-cell class="width200" *matCellDef="let row">{{row.location?.session?.name}}</mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="payoutsColumns.seat">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(payoutsColumns.seat)" cdkDragLockAxis="x"
                *matHeaderCellDef class="head-cell ob-draggable-column width200">
                {{'FORMS.LABELS.SEAT' | translate}}
            </mat-header-cell>
            <mat-cell class="width200" *matCellDef="let row">
                {{row.location?.sector?.name + (row.location?.row?.name ? (' - ' + ('FORMS.LABELS.ROW' | translate)
                + ' ' + row.location?.row?.name) : '') + (row.location?.num_seat ? (' - ' + ('FORMS.LABELS.SEAT_NAME' | translate) + ' '
                + row.location?.num_seat) : '')}}
            </mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="payoutsColumns.client">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(payoutsColumns.client)"
                cdkDragLockAxis="x" *matHeaderCellDef class="head-cell ob-draggable-column width200">
                {{'FORMS.LABELS.CLIENT' | translate}}
            </mat-header-cell>
            <mat-cell class="width200" *matCellDef="let row">
                <div class="flex flex-col flex-grow-0 flex-shrink-0 basis-full client-cell">
                    <div class="ob-text-ellipsis" [matTooltip]="(row.customer?.email ?? '')  + '\n' + (row.customer?.name ?? '') +
                        '\n' + (row.customer?.surname ?? '') + '\n' + (row.customer?.phone ?? '')">
                        @if($isMgr()){
                            <a class="ob-link" [routerLink]="['/customers', row.customer?.user_id]">
                                <ng-container [ngTemplateOutlet]="clientCellContent" />
                            </a>
                        }
                        @else {
                            <ng-container [ngTemplateOutlet]="clientCellContent" />
                        }
                        <ng-template #clientCellContent>
                            <div class="ob-text-ellipsis">
                                {{row.customer?.email ?? ''}}
                            </div>
                            <div class="ob-text-ellipsis">
                                {{row.customer?.name ?? ''}}
                            </div>
                            <div class="ob-text-ellipsis">
                                {{row.customer?.surname ?? ''}}
                            </div>
                        </ng-template>
                    </div>
                </div>
            </mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="payoutsColumns.clientId">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(payoutsColumns.seat)" cdkDragLockAxis="x"
                *matHeaderCellDef class="head-cell ob-draggable-column width200">
                {{'FORMS.LABELS.CLIENT_ID' | translate}}
            </mat-header-cell>
            <mat-cell class="width200" *matCellDef="let row">
                <div fxFlex="0 0 100%" fxLayoutAlign="start center">
                    <div class="ob-text-ellipsis">
                        {{row.customer?.user_id ?? '-'}}
                    </div>
                    @if(row?.customer?.user_id){
                        <app-copy-text [copyText]="row.customer.user_id"
                            class="copy-button" />
                    }
                </div>
            </mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="payoutsColumns.payoutType">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(payoutsColumns.seat)" cdkDragLockAxis="x"
                *matHeaderCellDef class="head-cell ob-draggable-column width200">
                {{'FORMS.LABELS.PAYOUT_TYPE' | translate}}
            </mat-header-cell>
            <mat-cell class="width200" *matCellDef="let row">
                {{row.payout_type ? (('PAYOUT.TYPE_OPTS.'+ row.payout_type) | translate) : '-'}}
            </mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="payoutsColumns.iban">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(payoutsColumns.iban)" cdkDragLockAxis="x"
                *matHeaderCellDef class="head-cell ob-draggable-column width200">
                {{'FORMS.LABELS.IBAN' | translate}}
            </mat-header-cell>
            <mat-cell class="width200 ob-text-ellipsis" *matCellDef="let row">{{row.customer?.iban ?? '-'}}</mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="payoutsColumns.bacs">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(payoutsColumns.bacs)" cdkDragLockAxis="x"
                *matHeaderCellDef class="head-cell ob-draggable-column width200">
                {{'FORMS.LABELS.BACS' | translate}}
            </mat-header-cell>
            <mat-cell class="width200 ob-text-ellipsis"
                *matCellDef="let row">
                {{(row.customer?.bacs_sort_code && row.customer?.bacs_account_number) ? row.customer?.bacs_sort_code + ' / ' + row.customer?.bacs_account_number : '-'}}
            </mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="payoutsColumns.price">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(payoutsColumns.price)" cdkDragLockAxis="x"
                *matHeaderCellDef class="head-cell ob-draggable-column width100">
                {{'FORMS.LABELS.AMOUNT' | translate}}
            </mat-header-cell>
            <mat-cell class="width100" *matCellDef="let row">{{row.price | localCurrency:row.currency}}</mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="payoutsColumns.purchaseDate">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(payoutsColumns.purchaseDate)" cdkDragLockAxis="x"
                *matHeaderCellDef mat-sort-header class="head-cell ob-draggable-column width130">
                {{'FORMS.LABELS.DATE' | translate}}
            </mat-header-cell>
            <mat-cell *matCellDef="let row" class="width130">
                {{(row.purchase_date | dateTime : dateTimeFormats.shortDateTime) ?? '-'}}
            </mat-cell>
        </ng-container>
        <ng-container stickyEnd [matColumnDef]="payoutsColumns.status">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(payoutsColumns.status)" cdkDragLockAxis="x"
                *matHeaderCellDef class="head-cell width200 final_column">
                <div class="payout-status">
                    {{'FORMS.LABELS.STATUS' | translate}}
                </div>
            </mat-header-cell>
            <mat-cell *matCellDef="let row" class="editable-cell width200 final_column" (click)="$event.stopPropagation()">
                <div class="payout-status flex flex-[100] flex-row items-center">
                    <div>
                        <span [class]="['status-dot', (row.payout_status ?? 'unpaid').toLowerCase()]"></span>
                        <span>
                            {{'PAYOUT_REQUESTS.STATUS_OPTS.' + row.payout_status + (row.pay_to_balance ? '_BALANCE' : '') | translate}}
                        </span>
                    </div>
                    @if(row.payout_status === 'FAILED' && row.payout_type === 'STRIPE'){
                        <app-help-button [message]="'PAYOUT.MANAGE_PAYOUT_AT_STRIPE_TOOLTIP' | translate" />
                    }
                </div>
            </mat-cell>
        </ng-container>
        <ng-container stickyEnd [matColumnDef]="payoutsColumns.actions">
            <mat-header-cell *matHeaderCellDef class="actions-cell head-cell"
                [class.float-actions-cell]="(isHandsetOrTablet$ | async) !== true">
                <button mat-stroked-button color="secondary" class="ob-button xsmall only-icon"
                    [matTooltip]="'ACTIONS.TABLE.SELECT_COLUMNS' | translate" (click)="changeColSelection()">
                    <mat-icon>settings</mat-icon>
                </button>
            </mat-header-cell>
            <mat-cell *matCellDef="let row" class="actions-cell"
                [class.float-actions-cell]="(isHandsetOrTablet$ | async) !== true">
                @let showMenu = row.payout_status === 'PAID' || row.payout_status === 'UNPAID' || !row.payout_status;
                <!-- {} -->
                <div (click)="$event.stopPropagation()"
                    [matTooltipDisabled]="row.payout_type !== 'STRIPE' || !showMenu"
                    [matTooltip]="'PAYOUT.MANAGE_PAYOUT_AT_STRIPE_TOOLTIP' | translate">
                    @if (row.payout_status === 'PAID' || row.payout_status === 'UNPAID' || !row.payout_status) {
                        <button mat-icon-button
                            [disabled]="(row.pay_to_balance && row.payout_status === 'PAID') || row.payout_type === 'STRIPE'"
                            [matMenuTriggerFor]="actionsListMenu" #menuTrigger="matMenuTrigger"
                            class="ob-button medium">
                            <mat-icon>more_horiz</mat-icon>
                        </button>
                        <mat-menu #actionsListMenu="matMenu" xPosition="before" (close)="menuTrigger">
                            @if(row.pay_to_balance){
                                @if(!row.payout_status || row.payout_status === 'UNPAID'){
                                    @let payoutPrice = row.price | localCurrency:row.currency;
                                <button (click)="payToBalance(row.uuid, payoutPrice)" mat-menu-item
                                    [attr.aria-label]="">
                                    {{'PAYOUTS.ACTIONS.PAY_TO_BALANCE' | translate}}
                                </button>
                            }
                        } @else {
                            @if(!row.payout_status || row.payout_status === 'UNPAID') {
                                <button (click)="updatePayoutStatus(row.uuid, 'PAID')" mat-menu-item [attr.aria-label]="">
                                    {{'PAYOUTS.ACTIONS.MARK_AS_PAID' | translate}}
                                </button>
                            }
                            @if(row.payout_status === 'PAID') {
                                <button (click)="updatePayoutStatus(row.uuid, 'UNPAID')" mat-menu-item [attr.aria-label]="">
                                    {{'PAYOUTS.ACTIONS.MARK_AS_UNPAID' | translate}}
                                </button>
                            }
                        }
                        </mat-menu>
                        }
                </div>
            </mat-cell>
        </ng-container>
        <mat-header-row *matHeaderRowDef="displayedColumns; sticky: true" />
        <mat-row *matRowDef="let row; columns: displayedColumns;" />
    </mat-table>
    @if((payoutsMetadata$ | async)?.total === 0){
        <div class="context-notification-container" fxFlex="0 50 100%" fxLayout="row" fxLayoutAlign="center start">
            <app-context-notification
                class="ob-context-notification" contextType="info" fxFlex.gt-sm="600px" fxFlex="80%" fxLayoutAlign="center start">
                @if(emptyListWithWordAndDates$ | async){
                    <div
                        fxLayout="column" fxLayoutAlign="start center" fxLayoutGap="20px">
                        <p>{{'TICKET.EMPTY_LIST_WITH_KEYWORD' | translate}}</p>
                        <button mat-stroked-button color="primary" type="button" class="ob-button medium"
                            [attr.aria-label]="'ORDER.REMOVE_DATES_FILTER' | translate"
                            (click)="removeDatesFilter()">
                            {{'TICKET.REMOVE_DATES_FILTER_BTN' | translate}}
                        </button>
                    </div>
                }
                @else {
                    <p>{{'LIST.EMPTY' | translate}}</p>
                }

            </app-context-notification>
        </div>
    }
</div>