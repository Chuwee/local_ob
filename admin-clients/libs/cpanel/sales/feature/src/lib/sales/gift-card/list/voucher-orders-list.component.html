<div class="list-container" fxFlex="100%" fxLayout="column">
    <div class="heading-container" fxLayout="row wrap" fxLayoutAlign="space-between start">
        <div>
            <h1 class="secondary mat-headline-3">{{'TITLES.VOUCHER_ORDERS' | translate}}</h1>
        </div>
        <div class="actions-container" fxFlex="auto" fxLayout="row wrap" fxLayoutAlign="end">
            <div class="filter-container" fxFlex="none">
                <button mat-icon-button class="ob-button medium" aria-label="refresh" (click)="refresh()">
                    <mat-icon>autorenew</mat-icon>
                </button>
            </div>
            @if (isExportEnabled$ | async) {
                <div class="filter-container" fxFlex="none">
                    <button mat-stroked-button color="tertiary" class="ob-button medium only-icon"
                        [matMenuTriggerFor]="ordersListMenu">
                        <mat-icon>more_horiz</mat-icon>
                    </button>
                    <mat-menu #ordersListMenu="matMenu">
                        <button mat-menu-item [disabled]="$voucherOrdersMetadata()?.total === 0" (click)="exportVoucherOrders()">
                            {{'ACTIONS.EXPORT.BTN' | translate}}
                        </button>
                    </mat-menu>
                </div>
            }
        </div>
    </div>
    <div class="heading-container" fxLayout="row" fxLayoutAlign="space-between center">
        <div fxFlex="80%" fxLayoutGap="20px" fxLayoutAlign="start center">
            <div class="filter-container" fxFlex="none">
                <app-popover-date-range-picker-filter />
            </div>
            <div class="filter-container" fxFlex="none">
                <app-popover appFilter>
                    <app-voucher-orders-list-filter [startDate]="startDate" [endDate]="endDate" #filterContent />
                </app-popover>
            </div>
            <div class="search-field" fxFlex="100%">
                <app-search-input [placeholder]="'VOUCHER_ORDER.SEARCH_INPUT' | translate" (valueChanged)="applyRelevance($event)" />
            </div>
        </div>
        <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px">
            @if ($voucherOrdersMetadata(); as ordersMetadata) {
                <p class="page-summary" [innerHTML]="'PAGINATION.PAGE_SUMMARY' | translate: ordersMetadata"></p>
            }
            <app-paginator [length]="$voucherOrdersMetadata()?.total" [pageSize]="pageSize" />
        </div>
    </div>
    <div class="heading-container">
        <app-chips appFilter />
    </div>
    @if ($voucherOrdersAggregatedData()?.aggregatedData) {
        <div class="heading-container heading-aggregated">
            <app-aggregated-data [aggregatedData]="$voucherOrdersAggregatedData().aggregatedData"
                [aggregationMetrics]="$voucherOrdersAggregatedData().aggregationMetrics"
                [currency]="$voucherOrdersAggregatedData().currency" [currencyFormat]="'narrow'" />
        </div>
    }
    @if ($reqInProgress()) {
        <div class="spinner-container">
            <mat-spinner />
        </div>
    }
    <mat-table class="ob-table ob-table-drop-list" [dataSource]="voucherOrders$ | async" [trackBy]="trackByFn"
        cdkDropList (cdkDropListDropped)="dropItem($event)" cdkDropListOrientation="horizontal"
        matSort (matSortChange)="unapplyRelevance()" [matSortActive]="initSortCol" [matSortDirection]="initSortDir" matSortDisableClear
        [attr.aria-label]="'TITLES.VOUCHER_ORDERS' | translate">
        <ng-container [matColumnDef]="voucherOrdersColumns.channel">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(voucherOrdersColumns.channel)" cdkDragLockAxis="x"
                *matHeaderCellDef class="head-cell ob-draggable-column">
                {{'FORMS.LABELS.CHANNEL' | translate}}
            </mat-header-cell>
            <mat-cell *matCellDef="let row">{{row.channel?.name}}</mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="voucherOrdersColumns.code">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(voucherOrdersColumns.code)"
                cdkDragLockAxis="x" *matHeaderCellDef class="head-cell ob-draggable-column">
                {{'FORMS.LABELS.CODE' | translate}}
            </mat-header-cell>
            <mat-cell *matCellDef="let row">
                <div fxFlex="0 0 100%" fxLayoutAlign="start center">
                    <span fxFlex="0 1 100%" appEllipsify [matTooltip]="row.code">{{row.code}}</span>
                    <app-copy-text [copyText]="row.code" class="copy-button" />
                </div>
            </mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="voucherOrdersColumns.type">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(voucherOrdersColumns.type)"
                cdkDragLockAxis="x" *matHeaderCellDef class="head-cell ob-draggable-column">
                {{'FORMS.LABELS.TYPE' | translate}}
            </mat-header-cell>
            <mat-cell *matCellDef="let row">{{('ENUMS.TYPE_OPTS.' + row.type) | translate}}</mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="voucherOrdersColumns.purchaseDate">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(voucherOrdersColumns.purchaseDate)"
                cdkDragLockAxis="x" *matHeaderCellDef mat-sort-header class="head-cell ob-draggable-column">
                {{'FORMS.LABELS.DATE' | translate}}
            </mat-header-cell>
            <mat-cell *matCellDef="let row">{{row.date | dateTime : dateTimeFormats.shortDateTime}}
            </mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="voucherOrdersColumns.client">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(voucherOrdersColumns.client)"
                cdkDragLockAxis="x" *matHeaderCellDef class="head-cell ob-draggable-column">
                {{'FORMS.LABELS.CLIENT' | translate}}
            </mat-header-cell>
            <mat-cell *matCellDef="let row">
                <div fxFlex="0 0 100%" fxLayoutAlign="start center">
                    <span class="ob-text-ellipsis"
                        [matTooltip]="(row.buyer_data?.email ?? '')  + '\n' + (row.buyer_data?.name ?? '') +
                            '\n' + (row.buyer_data?.surname ?? '') + '\n' + (row.buyer_data?.phone ?? '')">
                        {{row.buyer_data.email}}
                    </span>
                    <app-copy-text [copyText]="row.buyer_data.email" class="copy-button" />
                </div>
            </mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="voucherOrdersColumns.price">
            <mat-header-cell cdkDrag [cdkDragDisabled]="fixedColumns.includes(voucherOrdersColumns.price)"
                cdkDragLockAxis="x" *matHeaderCellDef class="head-cell final_price right ob-draggable-column">
                {{'FORMS.LABELS.PRICE' | translate}}
            </mat-header-cell>
            <mat-cell *matCellDef="let row" class="right final_price">
                {{row.price?.final | localCurrency:row.price?.currency}}
            </mat-cell>
        </ng-container>
        <ng-container [matColumnDef]="voucherOrdersColumns.actions">
            <mat-header-cell *matHeaderCellDef class="actions-cell head-cell"
                [class.float-actions-cell]="(isHandsetOrTablet$ | async) !== true">
                <button mat-stroked-button color="secondary" class="ob-button xsmall only-icon"
                    [matTooltip]="'ACTIONS.TABLE.SELECT_COLUMNS' | translate" (click)="changeColSelection()">
                    <mat-icon>settings</mat-icon>
                </button>
            </mat-header-cell>
            <mat-cell *matCellDef="let row" class="actions-cell"
                [class.float-actions-cell]="(isHandsetOrTablet$ | async) !== true" />
        </ng-container>
        <mat-header-row *matHeaderRowDef="displayedColumns; sticky: true" />
        <mat-row *matRowDef="let row; columns: displayedColumns;" class="interactive-row" [routerLink]="[row.code]" />
    </mat-table>
    @if ($voucherOrdersMetadata()?.total === 0) {
        <div class="context-notification-container" fxFlex="0 50 100%" fxLayout="row" fxLayoutAlign="center start">
            <app-context-notification
                class="ob-context-notification" contextType="info" fxFlex.gt-sm="600px" fxFlex="80%" fxLayoutAlign="center start">
                @if (emptyListWithWordAndDates$ | async) {
                <div fxLayout="column" fxLayoutAlign="start center" fxLayoutGap="20px">
                    <p>{{'TICKET.EMPTY_LIST_WITH_KEYWORD' | translate}}</p>
                    <button mat-stroked-button color="primary" type="button" class="ob-button medium"
                        [attr.aria-label]="'ORDER.REMOVE_DATES_FILTER' | translate"
                        (click)="removeDatesFilter()">
                        {{'TICKET.REMOVE_DATES_FILTER_BTN' | translate}}
                    </button>
                </div>
                } @else {
                    <p>{{'LIST.EMPTY' | translate}}</p>
                }
            </app-context-notification>
        </div>
    }
</div>
