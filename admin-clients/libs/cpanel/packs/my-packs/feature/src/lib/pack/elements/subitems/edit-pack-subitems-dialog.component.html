<div class="dialog-msg-container flex flex-col basis-full">
    <div mat-dialog-title class="dialog-title items-center basis-full">
        <h2 class="secondary title basis-full">{{'CHANNELS.PACK.VIEW_EDIT_SESSIONS' | translate}}</h2>
        <button mat-icon-button type="button" class="ob-button small" (click)="close()">
            <mat-icon>close</mat-icon>
        </button>
    </div>
    <div mat-dialog-content class="flex flex-col items-stretch">
        <form [formGroup]="form" class="flex flex-col items-stretch">
            <div class="flex flex-col basis-full">
                <p>{{'CHANNELS.PACK.SUBITEMS.DESCRIPTION' | translate}}</p>
                <mat-radio-group formControlName="selectAll" class="flex flex-col basis-full">
                    <mat-radio-button [value]="true" class="ob-radio-button vertical-list">
                        <div class="radio-button-text">{{'CHANNELS.PACK.SUBITEMS.SELECTION_ALL' | translate}}</div>
                    </mat-radio-button>
                    <mat-radio-button [value]="false" class="ob-radio-button vertical-list">
                        <div class="radio-button-text">{{'CHANNELS.PACK.SUBITEMS.SELECTION_RESTRICTED' | translate}}</div>
                    </mat-radio-button>
                </mat-radio-group>
                <div class="nested-content" [class.hidden]="selectAllCtrl.value === true"
                    [class.field-error]="subItemsCtrl.hasError('atLeastOneRequired') && form.touched">
                    <app-searchable-paginated-selection
                        [placeholder]="'FORMS.SEARCH.SESSIONS' | translate"
                        [pageSize]="pageSize" [form]="subItemsCtrl"
                        [data$]="sessionsData$" [metadata$]="sessionsMetadata$"
                        (loadData)="reloadSessionsList($event)">
                        <div slot="filter" class="badge-container" [class.empty]="(totalSessions$ | async) === 0">
                            {{subItemsCtrl.value?.length || 0}} / {{(totalSessions$ | async)}}
                        </div>
                        <button slot="filter" mat-icon-button color="tertiary" class="ob-button only-icon"
                            [class.active]="showSelectedOnly$ | async"
                            [disabled]="subItemsCtrl.value?.length === 0"
                            [matTooltip]="'CHANNELS.PACK.SUBITEMS.SHOW_SELECTED_TOOLTIP' | translate"
                            (click)="clickShowSelected()">
                            <mat-icon>visibility</mat-icon>
                        </button>
                        <div slot="filter" class="filter-container">
                            <app-edit-pack-subitems-dialog-filter
                                (filterChange)="filterChangeHandler($event)" />
                        </div>
                        <ng-template #selectionTemplate let-pageForm="pageForm" let-data="data" let-selectionChanged="selectionChanged">
                            <app-selection-list [data]="data" [pageForm]="pageForm" [disabledOptionPredicate]="shouldDisableSubItem"
                                [selectionChanged]="selectionChanged" class="small-rows">
                                <div slot="subheader" class="list-header">
                                    <div class="flex justify-between flex-1 items-center basis-full">
                                        <div class="name-header" appEllipsify>
                                            <span>{{'FORMS.LABELS.SESSIONS' | translate}}</span>
                                        </div>
                                        <div class="date-field" appEllipsify>
                                            <span>{{'FORMS.LABELS.DATE' | translate}}</span>
                                        </div>
                                    </div>
                                </div>
                                <ng-template #optionTemplate let-row>
                                    <div class="flex justify-between items-center flex-1">
                                        <div class="flex items-center" appEllipsify>
                                            <span>{{row.name}}</span>
                                        </div>
                                        <div class="date-field" appEllipsify>
                                            <span>{{row.start_date | dateTime : dateTimeFormats.shortDateTimeWithWeek}}</span>
                                        </div>
                                    </div>
                                </ng-template>
                            </app-selection-list>
                        </ng-template>
                    </app-searchable-paginated-selection>
                    @if(subItemsCtrl.touched && subItemsCtrl.invalid) {
                        @if (subItemsCtrl.hasError('atLeastOneRequired')) {
                            <mat-error>
                                {{'CHANNELS.PACK.SUBITEMS.AT_LEAST_ONE_REQUIRED' | translate}}
                            </mat-error>
                        }
                        @if (subItemsCtrl.hasError('maxSelectedItems')) {
                            <mat-error>
                                {{'CHANNELS.PACK.SUBITEMS.MAX_SELECTED_ITEMS' | translate}}
                            </mat-error>
                        }
                    }
                </div>
            </div>

        </form>
    </div>
    <div mat-dialog-actions class="dialog-actions">
        <div class="dialog-actions-info">
            <span>
                {{ 'CHANNELS.PACK.SUBITEMS.SELECTED' |translate : ({
                    selectedSessions: subItemsCtrl.value?.length || 0,
                    max: subItemsLimit
                }) }}
            </span>
            @if (subItemsCtrl.value?.length >= subItemsLimit) {
                <div class="flex items-center basis-full">
                    <mat-icon class="ob-icon xsmall info with-text">info</mat-icon>
                    <span>{{ 'CHANNELS.PACK.SUBITEMS.MAX_SELECTED_REACHED' | translate : ({max: subItemsLimit}) }}</span>
                </div>
            }
        </div>
        <div class="dialog-action-buttons">
            <button type="button" mat-button class="ob-button" (click)="close()">
                {{'FORMS.ACTIONS.CANCEL' | translate}}
            </button>
            <button mat-flat-button color="primary" type="button" class="ob-button" (click)="saveSubItems()"
                [disabled]="!form.dirty || (isInProgress$ | async)">
                {{'FORMS.ACTIONS.SAVE' | translate}}
            </button>
        </div>
    </div>
</div>
@if (isInProgress$ | async) {
    <div class="spinner-container">
        <mat-spinner />
    </div>
}
