<div class="dialog-msg-container">
    <div mat-dialog-title class="dialog-header-container">
        <div class="flex flex-row justify-between items-center">
            <h2 class="secondary title flex">
                {{ (!data.source ? 'CHANNELS.CROSS_SELLING.ADD_TITLE' : 'CHANNELS.CROSS_SELLING.ADD_SUGGESTION_TITLE') | translate}}
            </h2>
            <button mat-icon-button type="button" class="ob-button small" (click)="close()">
                <mat-icon>close</mat-icon>
            </button>
        </div>
    </div>
    @if(!data.source) {
        <app-wizard-bar
            [steps]="(currencies$ | async)?.length > 1
                ? ['CHANNELS.CROSS_SELLING.CURRENCY_SELECTION', 'CHANNELS.CROSS_SELLING.SOURCE_SELECTION', 'CHANNELS.CROSS_SELLING.SUGGESTION_SELECTION']
                : ['CHANNELS.CROSS_SELLING.SOURCE_SELECTION', 'CHANNELS.CROSS_SELLING.SUGGESTION_SELECTION']">
        </app-wizard-bar>
    }


    <div mat-dialog-content class="with-wizard-bar">
        @defer (when currencies$) {
            @if (!data.source && currentStep === 1) {
                <div class="table-container">
                    <app-currency-single-selector [currencyCtrl]="currencyControl" [currencies$]="currencies$"
                        [selectionTypeInput]="'dropdown'" />
                </div>
            }
        }
        @if (currentStep === 3) {
            <div class="cart-elements-container flex flex-col gap-4">
                <span class="cart-elements-title">{{'CHANNELS.CROSS_SELLING.ORIGIN_COLUMN' | translate}}</span>
                <div class="cart-elements">
                    @if(!originsForm.value.sessions || originsForm.value.sessions?.length === 0){
                        @for (event of originsForm.value.events; track $index) {
                            <p class="cart-elements-names">
                                <span class="flex flex-row items-center">
                                    <span>{{event.name}}</span>
                                </span>
                            </p>
                        }
                    } @else {
                        @for (session of originsForm.value.sessions; track session.id) {
                            <p class="cart-elements-names">
                                <span class="flex flex-row items-center gap-1">
                                    <span>
                                        {{session.name + ' ' + (session.startDate| dateTime : dateTimeFormats.shortDateTimeWithWeek)}}
                                    </span>
                                    <span class="parent-name">
                                        - {{originsForm.value.events[0].name}}
                                    </span>
                                </span>
                            </p>
                        }
                    }
                </div>
                <mat-divider />
            </div>
        }
        <div class="flex flex-row flex-wrap">
            <div class="table-container basis-full">
                @if (currentStep === 2 && !data.source) {
                    <app-channel-cross-selling-selector-table [maxSelection]="maxSelection"
                        [form]="originsForm" [channelId]="data.channelId" [currencyCode]="currencyControl.value">
                    </app-channel-cross-selling-selector-table>
                }
                @if(currentStep === 3) {
                    <app-channel-cross-selling-selector-table [suggestionsData$]="suggestionsData$"
                        [form]="destinationsForm" [channelId]="data.channelId" [currencyCode]="currencyControl.value"
                        [eventsToDisable]="(data.source?.type === channelSuggestionType.event) ? [data.source] :
                originsForm.value.allSessions ? originsForm.value.events : []"
                        [sessionsToDisable]="(data.source && data.source.type === channelSuggestionType.session) ? [data.source] :
                originsForm.value.allSessions ? [] : originsForm.value.sessions" [maxSelection]="maxSelection">
                    </app-channel-cross-selling-selector-table>
                }
            </div>
        </div>
    </div>

    <div mat-dialog-actions class="flex justify-center align-center">
        @if (currentStep !== 1){
            <div class="footer-info flex flex-col items-start">
                <div class="max-reached-info footer-info-container flex flex-row items-center">
                    <mat-icon class="ob-icon xsmall info with-text">info</mat-icon>
                    <span>{{ 'CHANNELS.CROSS_SELLING.MAX_SUGGESTIONS_INFO' | translate : { value: maxSelection} }}</span>
                </div>
            </div>
        }
        <div class="flex flex-1 justify-end">
            <div class="flex justify-start items-center">
                <button type="button" mat-button class="ob-button" (click)="close()">
                    {{'FORMS.ACTIONS.CANCEL' | translate}}
                </button>
                @if(!data.source) {
                    <button mat-stroked-button color="tertiary" type="button" class="ob-button" (click)="handleBackClick()"
                        [disabled]="currentStep === 1">
                        <mat-icon>arrow_back</mat-icon>
                        {{'FORMS.ACTIONS.PREVIOUS' | translate}}
                    </button>
                }
                @if(currentStep !== 3){
                    <button mat-flat-button color="primary" type="button" class="ob-button"
                        [disabled]="(currentStep === 1 && !currencyControl.value) || (currentStep === 2 && !originsForm.valid)"
                        (click)="handleNextClick()">
                        {{'FORMS.ACTIONS.NEXT' | translate}}
                        <mat-icon iconPositionEnd>arrow_forward</mat-icon>
                    </button>
                } @else {
                    <button #saveBtn mat-flat-button color="primary" type="button" class="ob-button"
                        [disabled]="!originsForm.valid || !destinationsForm.valid" (click)="save()">
                        {{'FORMS.ACTIONS.CREATE' | translate}}
                    </button>
                }
            </div>
        </div>
    </div>
</div>
@if(isLoading$ | async) {
    <div class="spinner-container">
        <mat-spinner />
    </div>
}
