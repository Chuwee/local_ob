<div class="dialog-msg-container" fxLayout="column nowrap" fxFlex="100%">
    <div mat-dialog-title fxFlex="auto" fxLayout="row" fxFlexAlign="start">
        <h2 fxFlex="100%" class="secondary title">{{'TITLES.SET_PASSWORD' | translate}}</h2>
        <button mat-icon-button type="button" class="ob-button small" (click)="close()">
            <mat-icon>close</mat-icon>
        </button>
    </div>
    <div mat-dialog-content fxLayout="column" fxLayoutAlign="start stretch" fxLayoutGap="16px">
        @if ($isMyUser() || !$isOperator()) {
            @if ($maxPasswordStorage() === 1) {
                <span>{{'LOGIN.PASSWORD_EXPIRED.INFO_CONDITION' | translate}}</span>
            } @else if ($maxPasswordStorage() > 1) {
                <span>{{'LOGIN.PASSWORD_EXPIRED.INFO_CONDITIONS' | translate: { value: $maxPasswordStorage() } }}</span>
            }
        }
        @if ($passwordNotValid()) {
            <app-context-notification class="ob-context-notification" contextType="warn" fxLayoutAlign="center start">
                <span>{{'LOGIN.PASSWORD_EXPIRED.PREVIOUSLY_USED' | translate}}</span>
            </app-context-notification>
        }
        <form [formGroup]="form" fxLayout="column" fxLayoutAlign="start stretch">
            <mat-form-field [fxShow]="$isMyUser() || !$isOperator()" appearance="outline" class="ob-form-field field-with-label">
                <mat-label>{{'FORMS.LABELS.PASSWORD' | translate}}</mat-label>
                <input [type]="$showOldPasswordValue() ? 'text' : 'password'" matInput aria-label="oldPassword"
                    [placeholder]="'FORMS.LABELS.PASSWORD' | translate" formControlName="oldPassword">
                @if (form.get('oldPassword').value) {
                    <button mat-icon-button matSuffix class="ob-button large" type="button"
                        (click)="handleShowOldPasswordValue()">
                        <mat-icon>{{$showOldPasswordValue() ? 'visibility_off' : 'visibility'}}</mat-icon>
                    </button>
                }
                <mat-error [ob-form-errors]="form" field="oldPassword"></mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline" class="ob-form-field field-with-label">
                <mat-label>{{'FORMS.LABELS.NEW_PASSWORD' | translate}}</mat-label>
                <input #newPassword [type]="$showNewPasswordValue() ? 'text' : 'password'" matInput aria-label="newPassword"
                    (blur)="onNewPwdBlur()" [placeholder]="'FORMS.LABELS.NEW_PASSWORD' | translate" formControlName="newPassword">
                @if (form.get('newPassword').value) {
                    <button mat-icon-button matSuffix class="ob-button large" type="button" (click)="handleShowNewPasswordValue()">
                        <mat-icon>{{$showNewPasswordValue() ? 'visibility_off' : 'visibility'}}</mat-icon>
                    </button>
                }
            </mat-form-field>
            <div fxLayout="row wrap" fxLayoutAlign="start center" class="conditions-container">
                @for (error of (passwordConditionErrors | keyvalue); track error.key) {
                    <div fxLayoutGap="5px" fxFlex="50%" fxLayoutAlign="start end">
                        <mat-icon class="accomplished-condition-check ob-icon xsmall"
                            [class.accomplished]="!form.get('newPassword').hasError(error.key) && newPassword.value">
                            done
                        </mat-icon>
                        <span class="mat-caption password-condition-label"
                            [class.error]="form.hasError(error.key, 'newPassword') && $isNewPwdBlur()">
                            {{('USER.PASSWORD.' + error.value) | translate}}
                        </span>
                    </div>
                }
            </div>
            <mat-form-field appearance="outline" class="ob-form-field field-with-label">
                <mat-label>{{'FORMS.LABELS.CONFIRM_PASSWORD' | translate}}</mat-label>
                <input [type]="$showConfirmPasswordValue() ? 'text' : 'password'" matInput aria-label="confirmPassword"
                    [placeholder]="'FORMS.LABELS.CONFIRM_PASSWORD' | translate" formControlName="confirmPassword">
                @if (form.get('confirmPassword').value) {
                    <button mat-icon-button matSuffix class="ob-button large" type="button" (click)="handleShowConfirmPasswordValue()">
                        <mat-icon>{{$showConfirmPasswordValue() ? 'visibility_off' : 'visibility'}}</mat-icon>
                    </button>
                }
                <mat-error [ob-form-errors]="form" field="confirmPassword"></mat-error>
            </mat-form-field>
        </form>
    </div>
    <div mat-dialog-actions fxLayoutAlign="end">
        <button type="button" mat-button class="ob-button" (click)="close()">
            {{'FORMS.ACTIONS.CANCEL' | translate}}
        </button>
        <button mat-flat-button color="primary" type="button" class="ob-button"
            (click)="setPassword()" [disabled]="$loading()">
            {{'FORMS.ACTIONS.SAVE' | translate}}
        </button>
    </div>
</div>
@if ($loading()) {
    <div class="spinner-container">
        <mat-spinner></mat-spinner>
    </div>
}
