@let hasRules = !!$rateLimit()?.rules?.length;
<div class="user-rate-limit-toggle">
    <mat-slide-toggle class="ob-slide-toggle" [checked]="!($rateLimit()?.unlimited ?? true)" (change)="updateUnlimited($event)"
        [disabled]="hasRules">
        {{ 'USER.RATE_LIMIT.UNLIMITED.LABEL' | translate }}
</mat-slide-toggle>
</div>
<mat-divider />
<app-form-container layout="menu" hideActionBar>
    <p>{{ 'USER.RATE_LIMIT.DESCRIPTION' | translate }}</p>
    @if(hasRules){
        <div class="button-container flex justify-end">
            <button mat-stroked-button color="primary" type="button" class="ob-button medium"
                [attr.aria-label]="'USER.RATE_LIMIT.ACTIONS.CREATE' | translate"
                (click)="openCreateDialog()" [disabled]="$rateLimit()?.unlimited">
                <mat-icon fontIcon="add" />
                {{'USER.RATE_LIMIT.ACTIONS.CREATE' | translate}}
            </button>
        </div>
    }
    <mat-accordion [multi]="false" [togglePosition]="'before'">
        @for(rule of $rateLimit()?.rules; track $index){
            <mat-expansion-panel #panel class="ob-expansion-card">
                <mat-expansion-panel-header expandedHeight="*" collapsedHeight="*">
                    <mat-panel-title>{{ rule.pattern }}</mat-panel-title>
                    <div class="flex flex-row">
                        <button type="button" mat-icon-button class="ob-button medium"
                            [attr.aria-label]="'FORM.ACTIONS.EDIT' | translate"
                            (click)="openEditDialog($index);$event.stopPropagation()">
                            <mat-icon class="ob-black" fontIcon=" edit" />
                        </button>
                        <button type="button" mat-icon-button class="ob-button medium"
                            [attr.aria-label]="'FORMS.ACTIONS.DELETE' | translate"
                            (click)="openDeleteDialog(rule.pattern, $index);$event.stopPropagation()">
                            <mat-icon class="ob-black" fontIcon="delete" />
                        </button>
                    </div>
                </mat-expansion-panel-header>
                <div class="expansion-panel-container flex flex-col">
                    @for(quota of rule.quotas; track $index){
                        <div class="flex flex-row justify-between">
                            <span>
                                <b>{{ quota.limit }}</b> {{ 'USER.RATE_LIMIT.FORMS.QUOTAS.TEXT' | translate }} <b>{{ quota.period }}</b>
                                {{ 'USER.RATE_LIMIT.FORMS.TIME_UNIT.' + quota.time_unit | translate }}
                            </span>
                        </div>
                    }
                </div>
            </mat-expansion-panel>
        } @empty {
            <app-empty-state
                [hideImage]="true"
                [title]="'USER.RATE_LIMIT.ACTIONS.EMPTY' | translate"
                [description]="'USER.RATE_LIMIT.ACTIONS.EMPTY_DESCRIPTION' | translate">
                <div [matTooltip]="'USER.RATE_LIMIT.ACTIONS.TOOLTIP' | translate" [matTooltipDisabled]="!$rateLimit()?.unlimited">
                    <button mat-stroked-button class="ob-button" color="primary" (click)="openCreateDialog()"
                        [disabled]="$rateLimit()?.unlimited">
                        <mat-icon fontIcon="add" />
                        {{'USER.RATE_LIMIT.ACTIONS.CREATE' | translate}}
                    </button>
                </div>
            </app-empty-state>
        }
    </mat-accordion>
    @if($loading()){
        <div class="spinner-container">
            <mat-spinner />
        </div>
    }
</app-form-container>